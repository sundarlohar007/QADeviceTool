<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Package Name="QA/QC Device Tool"
           Manufacturer="Sundar Lohar"
           Version="2.2.0.0"
           UpgradeCode="A1B2C3D4-E5F6-7890-ABCD-EF1234567890"
           Scope="perMachine">

    <MajorUpgrade DowngradeErrorMessage="A newer version of QA/QC Device Tool is already installed." AllowSameVersionUpgrades="yes" />
    <MediaTemplate EmbedCab="yes" />

    <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
    <WixVariable Id="WixUILicenseRtf" Value="!(bindpath.installer)License.rtf" />

    <!-- Custom Actions to explicitly force-kill background utilities -->
    <CustomAction Id="KillApp" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM QADeviceTool.exe /T" Execute="immediate" Return="ignore" />
    <CustomAction Id="KillAdb" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM adb.exe /T" Execute="immediate" Return="ignore" />
    <CustomAction Id="KillScrcpy" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM scrcpy.exe /T" Execute="immediate" Return="ignore" />
    <CustomAction Id="KillIsyslog" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM idevicesyslog.exe /T" Execute="immediate" Return="ignore" />
    <CustomAction Id="KillIinstaller" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM ideviceinstaller.exe /T" Execute="immediate" Return="ignore" />
    <CustomAction Id="KillIinfo" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM ideviceinfo.exe /T" Execute="immediate" Return="ignore" />
    <CustomAction Id="KillIid" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM idevice_id.exe /T" Execute="immediate" Return="ignore" />

    <InstallExecuteSequence>
        <Custom Action="KillApp" Before="InstallValidate" />
        <Custom Action="KillAdb" Before="InstallValidate" />
        <Custom Action="KillScrcpy" Before="InstallValidate" />
        <Custom Action="KillIsyslog" Before="InstallValidate" />
        <Custom Action="KillIinstaller" Before="InstallValidate" />
        <Custom Action="KillIinfo" Before="InstallValidate" />
        <Custom Action="KillIid" Before="InstallValidate" />
    </InstallExecuteSequence>

    <!-- Directory structure -->
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="INSTALLFOLDER" Name="QAQCDeviceTool">
        <Directory Id="ToolsDir" Name="tools">
          <Directory Id="ScrcpyDir" Name="scrcpy-win64-v3.3.4" />
          <Directory Id="IMobileDir" Name="iMobileDevice" />
        </Directory>
        <Directory Id="AssetsDir" Name="assets" />
        <Directory Id="LicensesDir" Name="licenses" />
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="AppMenuFolder" Name="QA QC Device Tool" />
    </StandardDirectory>
    <StandardDirectory Id="DesktopFolder" />

    <!-- ═══════ Main Application ═══════ -->
    <ComponentGroup Id="MainApp" Directory="INSTALLFOLDER">
      <Component Id="c_exe" Guid="*">
        <File Id="MainExecutable" Source="!(bindpath.publish)\QADeviceTool.exe" KeyPath="yes" />
      </Component>
      <Component Id="c_pdb" Guid="*">
        <File Source="!(bindpath.publish)\QADeviceTool.pdb" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- ═══════ Scrcpy + ADB (15 files) ═══════ -->
    <ComponentGroup Id="ScrcpyTools" Directory="ScrcpyDir">
      <Component Id="s_adb" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\adb.exe" KeyPath="yes" /></Component>
      <Component Id="s_scrcpy" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\scrcpy.exe" KeyPath="yes" /></Component>
      <Component Id="s_server" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\scrcpy-server" KeyPath="yes" /></Component>
      <Component Id="s_AdbWinApi" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\AdbWinApi.dll" KeyPath="yes" /></Component>
      <Component Id="s_AdbWinUsbApi" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\AdbWinUsbApi.dll" KeyPath="yes" /></Component>
      <Component Id="s_avcodec" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\avcodec-61.dll" KeyPath="yes" /></Component>
      <Component Id="s_avformat" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\avformat-61.dll" KeyPath="yes" /></Component>
      <Component Id="s_avutil" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\avutil-59.dll" KeyPath="yes" /></Component>
      <Component Id="s_libusb" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\libusb-1.0.dll" KeyPath="yes" /></Component>
      <Component Id="s_sdl2" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\SDL2.dll" KeyPath="yes" /></Component>
      <Component Id="s_swresample" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\swresample-5.dll" KeyPath="yes" /></Component>
      <Component Id="s_icon" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\icon.png" KeyPath="yes" /></Component>
      <Component Id="s_bat1" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\open_a_terminal_here.bat" KeyPath="yes" /></Component>
      <Component Id="s_bat2" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\scrcpy-console.bat" KeyPath="yes" /></Component>
      <Component Id="s_vbs" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\scrcpy-noconsole.vbs" KeyPath="yes" /></Component>
    </ComponentGroup>

    <!-- ═══════ iMobileDevice (47 files) ═══════ -->
    <ComponentGroup Id="IMobileTools" Directory="IMobileDir">
      <Component Id="i_idevice_id" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\idevice_id.exe" KeyPath="yes" /></Component>
      <Component Id="i_ideviceactivation" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\ideviceactivation.exe" KeyPath="yes" /></Component>
      <Component Id="i_idevicebackup" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\idevicebackup.exe" KeyPath="yes" /></Component>
      <Component Id="i_idevicebackup2" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\idevicebackup2.exe" KeyPath="yes" /></Component>
      <Component Id="i_idevicecrashreport" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\idevicecrashreport.exe" KeyPath="yes" /></Component>
      <Component Id="i_idevicedate" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\idevicedate.exe" KeyPath="yes" /></Component>
      <Component Id="i_idevicedebug" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\idevicedebug.exe" KeyPath="yes" /></Component>
      <Component Id="i_idevicedebugserverproxy" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\idevicedebugserverproxy.exe" KeyPath="yes" /></Component>
      <Component Id="i_idevicediagnostics" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\idevicediagnostics.exe" KeyPath="yes" /></Component>
      <Component Id="i_ideviceenterrecovery" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\ideviceenterrecovery.exe" KeyPath="yes" /></Component>
      <Component Id="i_ideviceimagemounter" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\ideviceimagemounter.exe" KeyPath="yes" /></Component>
      <Component Id="i_ideviceinfo" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\ideviceinfo.exe" KeyPath="yes" /></Component>
      <Component Id="i_ideviceinstaller" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\ideviceinstaller.exe" KeyPath="yes" /></Component>
      <Component Id="i_idevicename" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\idevicename.exe" KeyPath="yes" /></Component>
      <Component Id="i_idevicenotificationproxy" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\idevicenotificationproxy.exe" KeyPath="yes" /></Component>
      <Component Id="i_idevicepair" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\idevicepair.exe" KeyPath="yes" /></Component>
      <Component Id="i_ideviceprovision" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\ideviceprovision.exe" KeyPath="yes" /></Component>
      <Component Id="i_idevicescreenshot" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\idevicescreenshot.exe" KeyPath="yes" /></Component>
      <Component Id="i_idevicesyslog" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\idevicesyslog.exe" KeyPath="yes" /></Component>
      <Component Id="i_iproxy" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\iproxy.exe" KeyPath="yes" /></Component>
      <Component Id="i_irecovery" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\irecovery.exe" KeyPath="yes" /></Component>
      <Component Id="i_plistutil" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\plistutil.exe" KeyPath="yes" /></Component>
      <Component Id="i_plist_cmp" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\plist_cmp.exe" KeyPath="yes" /></Component>
      <Component Id="i_plist_test" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\plist_test.exe" KeyPath="yes" /></Component>
      <Component Id="i_usbmuxd" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\usbmuxd.exe" KeyPath="yes" /></Component>
      <!-- DLLs -->
      <Component Id="i_getopt" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\getopt.dll" KeyPath="yes" /></Component>
      <Component Id="i_ideviceactivation_dll" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\ideviceactivation.dll" KeyPath="yes" /></Component>
      <Component Id="i_imobiledevice_net" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\imobiledevice-net-lighthouse.dll" KeyPath="yes" /></Component>
      <Component Id="i_imobiledevice_dll" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\imobiledevice.dll" KeyPath="yes" /></Component>
      <Component Id="i_irecovery_dll" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\irecovery.dll" KeyPath="yes" /></Component>
      <Component Id="i_libcharset" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\libcharset.dll" KeyPath="yes" /></Component>
      <Component Id="i_libcurl" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\libcurl.dll" KeyPath="yes" /></Component>
      <Component Id="i_libeay32" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\libeay32.dll" KeyPath="yes" /></Component>
      <Component Id="i_libiconv" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\libiconv.dll" KeyPath="yes" /></Component>
      <Component Id="i_libusb_10" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\libusb-1.0.dll" KeyPath="yes" /></Component>
      <Component Id="i_libusb_usbdk" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\libusb-usbdk-1.0.dll" KeyPath="yes" /></Component>
      <Component Id="i_libusb0" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\libusb0.dll" KeyPath="yes" /></Component>
      <Component Id="i_libxml2" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\libxml2.dll" KeyPath="yes" /></Component>
      <Component Id="i_lzma" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\lzma.dll" KeyPath="yes" /></Component>
      <Component Id="i_plist_dll" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\plist.dll" KeyPath="yes" /></Component>
      <Component Id="i_pthreads" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\pthreadsVC2.dll" KeyPath="yes" /></Component>
      <Component Id="i_readline" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\readline.dll" KeyPath="yes" /></Component>
      <Component Id="i_ssleay32" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\ssleay32.dll" KeyPath="yes" /></Component>
      <Component Id="i_usbmuxd_dll" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\usbmuxd.dll" KeyPath="yes" /></Component>
      <Component Id="i_vcruntime" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\vcruntime140.dll" KeyPath="yes" /></Component>
      <Component Id="i_zip" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\zip.dll" KeyPath="yes" /></Component>
      <Component Id="i_zlib1" Guid="*"><File Source="!(bindpath.publish)tools\iMobileDevice\zlib1.dll" KeyPath="yes" /></Component>
    </ComponentGroup>

    <!-- ═══════ Shortcuts ═══════ -->
    <ComponentGroup Id="Shortcuts" Directory="AppMenuFolder">
      <Component Id="StartMenuShortcut" Guid="22222222-2222-2222-2222-222222222222">
        <Shortcut Id="StartMenuSC" Name="QA QC Device Tool"
                  Target="[#MainExecutable]" WorkingDirectory="INSTALLFOLDER" />
        <RemoveFolder Id="CleanMenu" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\QAQCDeviceTool" Name="installed" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="DesktopSC" Directory="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="33333333-3333-3333-3333-333333333333">
        <Shortcut Id="DesktopSC" Name="QA QC Device Tool"
                  Target="[#MainExecutable]" WorkingDirectory="INSTALLFOLDER" />
        <RegistryValue Root="HKCU" Key="Software\QAQCDeviceTool" Name="desktopsc" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="Assets" Directory="AssetsDir">
      <Component Id="c_adbzip" Guid="*">
        <File Id="f_adbzip" Source="!(bindpath.installer)\assets\platform-tools-latest-windows.zip" KeyPath="yes" />
      </Component>
      <Component Id="c_driverzip" Guid="*">
        <File Id="f_driverzip" Source="!(bindpath.installer)\assets\usb_driver_r13-windows.zip" KeyPath="yes" />
      </Component>
      <Component Id="c_setupandroid" Guid="*">
        <File Id="f_setupandroid" Source="!(bindpath.installer)\assets\SetupAndroid.ps1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="LicensesGroup" Directory="LicensesDir">
      <Component Id="c_license_notices" Guid="*">
        <File Source="!(bindpath.publish)\licenses\THIRD_PARTY_NOTICES.txt" KeyPath="yes" />
      </Component>
      <Component Id="c_license_scrcpy" Guid="*">
        <File Source="!(bindpath.publish)\licenses\LICENSE-scrcpy.txt" KeyPath="yes" />
      </Component>
      <Component Id="c_license_imobile" Guid="*">
        <File Source="!(bindpath.publish)\licenses\LICENSE-libimobiledevice.txt" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- ═══════ Features ═══════ -->
    <Feature Id="ProductFeature" Title="QA/QC Device Tool" Level="1">
      <ComponentGroupRef Id="MainApp" />
      <ComponentGroupRef Id="ScrcpyTools" />
      <ComponentGroupRef Id="IMobileTools" />
      <ComponentGroupRef Id="Shortcuts" />
      <ComponentGroupRef Id="DesktopSC" />
      <ComponentGroupRef Id="Assets" />
      <ComponentGroupRef Id="LicensesGroup" />
    </Feature>

    <!-- ═══════ Custom Actions ═══════ -->
    <CustomAction Id="CA_AndroidSetup" Execute="deferred" Impersonate="no" Return="ignore"
                  Directory="INSTALLFOLDER"
                  ExeCommand="powershell.exe -WindowStyle Hidden -NoProfile -NonInteractive -ExecutionPolicy Bypass -File &quot;[INSTALLFOLDER]assets\SetupAndroid.ps1&quot; &quot;[INSTALLFOLDER]&quot;" />

    <CustomAction Id="CA_AppleCheck" Execute="immediate" Return="ignore"
                  Directory="INSTALLFOLDER"
                  ExeCommand="powershell.exe -WindowStyle Hidden -NoProfile -ExecutionPolicy Bypass -Command &quot;if(!(Get-Service 'Apple Mobile Device Service' -ErrorAction Ignore)){ Add-Type -AssemblyName System.Windows.Forms; if([System.Windows.Forms.MessageBox]::Show('Apple Mobile Device Service (iTunes) is missing on this system. While iOS support is optional, it is required if you plan to connect Apple devices. Would you like to open your browser to download iTunes now?', 'Apple iOS Support Missing', 'YesNo', 'Information') -eq 'Yes') { Start-Process 'https://secure-appldnld.apple.com/itunes12/001-80053-20210422-E8A3B28C-A3B2-11EB-BE07-CE1B67FC6302/iTunes64Setup.exe'} }&quot;" />

    <InstallExecuteSequence>
      <Custom Action="CA_AppleCheck" After="CostFinalize" Condition="NOT Installed AND UILevel &gt; 3" />
      <Custom Action="CA_AndroidSetup" Before="InstallFinalize" Condition="NOT Installed" />
    </InstallExecuteSequence>

  </Package>
</Wix>
