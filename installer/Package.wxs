<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

  <Package Name="QA/QC Device Tool"
           Manufacturer="Sundar Lohar"
           Version="2.4.0.0"
           UpgradeCode="A1B2C3D4-E5F6-7890-ABCD-EF1234567890"
           Scope="perMachine">

    <MajorUpgrade DowngradeErrorMessage="A newer version of QA/QC Device Tool is already installed." AllowSameVersionUpgrades="yes" />
    <MediaTemplate EmbedCab="yes" />

    <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
    <WixVariable Id="WixUILicenseRtf" Value="!(bindpath.installer)License.rtf" />

    <!-- Custom Actions to explicitly force-kill background utilities -->
    <CustomAction Id="KillApp" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM QADeviceTool.exe /T" Execute="immediate" Return="ignore" />
    <CustomAction Id="KillAdb" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM adb.exe /T" Execute="immediate" Return="ignore" />
    <CustomAction Id="KillScrcpy" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM scrcpy.exe /T" Execute="immediate" Return="ignore" />
    <CustomAction Id="KillIsyslog" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM idevicesyslog.exe /T" Execute="immediate" Return="ignore" />
    <CustomAction Id="KillIinstaller" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM ideviceinstaller.exe /T" Execute="immediate" Return="ignore" />
    <CustomAction Id="KillIinfo" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM ideviceinfo.exe /T" Execute="immediate" Return="ignore" />
    <CustomAction Id="KillIid" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM idevice_id.exe /T" Execute="immediate" Return="ignore" />
    <CustomAction Id="KillAfc" Directory="TARGETDIR" ExeCommand="&quot;[SystemFolder]taskkill.exe&quot; /F /IM afcclient.exe /T" Execute="immediate" Return="ignore" />

    <InstallExecuteSequence>
        <Custom Action="KillApp" Before="InstallValidate" />
        <Custom Action="KillAdb" Before="InstallValidate" />
        <Custom Action="KillScrcpy" Before="InstallValidate" />
        <Custom Action="KillIsyslog" Before="InstallValidate" />
        <Custom Action="KillIinstaller" Before="InstallValidate" />
        <Custom Action="KillIinfo" Before="InstallValidate" />
        <Custom Action="KillIid" Before="InstallValidate" />
        <Custom Action="KillAfc" Before="InstallValidate" />
    </InstallExecuteSequence>

    <!-- Directory structure -->
    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="INSTALLFOLDER" Name="QAQCDeviceTool">
        <Directory Id="ToolsDir" Name="tools">
          <Directory Id="ScrcpyDir" Name="scrcpy-win64-v3.3.4" />
          <Directory Id="IMobileDir" Name="iMobileDevice" />
        </Directory>
        <Directory Id="AssetsDir" Name="assets" />
        <Directory Id="LicensesDir" Name="licenses" />
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="AppMenuFolder" Name="QA QC Device Tool" />
    </StandardDirectory>
    <StandardDirectory Id="DesktopFolder" />

    <!-- ═══════ Main Application ═══════ -->
    <!-- EXE kept explicit so shortcuts can reference MainExecutable by Id -->
    <ComponentGroup Id="MainApp" Directory="INSTALLFOLDER">
      <Component Id="c_exe" Guid="*">
        <File Id="MainExecutable" Source="!(bindpath.publish)\QADeviceTool.exe" KeyPath="yes" />
      </Component>
      <Component Id="c_pdb" Guid="*">
        <File Source="!(bindpath.publish)\QADeviceTool.pdb" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- ═══════ .NET Native WPF Runtime DLLs ═══════ -->
    <!-- These are excluded from PublishSingleFile and MUST sit next to the EXE -->
    <ComponentGroup Id="NativeRuntime" Directory="INSTALLFOLDER">
      <Component Id="c_d3d" Guid="*">
        <File Source="!(bindpath.publish)\D3DCompiler_47_cor3.dll" KeyPath="yes" />
      </Component>
      <Component Id="c_penimc" Guid="*">
        <File Source="!(bindpath.publish)\PenImc_cor3.dll" KeyPath="yes" />
      </Component>
      <Component Id="c_wpfnative" Guid="*">
        <File Source="!(bindpath.publish)\PresentationNative_cor3.dll" KeyPath="yes" />
      </Component>
      <Component Id="c_vcruntime" Guid="*">
        <File Source="!(bindpath.publish)\vcruntime140_cor3.dll" KeyPath="yes" />
      </Component>
      <Component Id="c_wpfgfx" Guid="*">
        <File Source="!(bindpath.publish)\wpfgfx_cor3.dll" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- ═══════ Scrcpy + ADB (15 files) ═══════ -->
    <ComponentGroup Id="ScrcpyTools" Directory="ScrcpyDir">
      <Component Id="s_adb" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\adb.exe" KeyPath="yes" /></Component>
      <Component Id="s_scrcpy" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\scrcpy.exe" KeyPath="yes" /></Component>
      <Component Id="s_server" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\scrcpy-server" KeyPath="yes" /></Component>
      <Component Id="s_AdbWinApi" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\AdbWinApi.dll" KeyPath="yes" /></Component>
      <Component Id="s_AdbWinUsbApi" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\AdbWinUsbApi.dll" KeyPath="yes" /></Component>
      <Component Id="s_avcodec" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\avcodec-61.dll" KeyPath="yes" /></Component>
      <Component Id="s_avformat" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\avformat-61.dll" KeyPath="yes" /></Component>
      <Component Id="s_avutil" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\avutil-59.dll" KeyPath="yes" /></Component>
      <Component Id="s_libusb" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\libusb-1.0.dll" KeyPath="yes" /></Component>
      <Component Id="s_sdl2" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\SDL2.dll" KeyPath="yes" /></Component>
      <Component Id="s_swresample" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\swresample-5.dll" KeyPath="yes" /></Component>
      <Component Id="s_icon" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\icon.png" KeyPath="yes" /></Component>
      <Component Id="s_bat1" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\open_a_terminal_here.bat" KeyPath="yes" /></Component>
      <Component Id="s_bat2" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\scrcpy-console.bat" KeyPath="yes" /></Component>
      <Component Id="s_vbs" Guid="*"><File Source="!(bindpath.publish)tools\scrcpy-win64-v3.3.4\scrcpy-noconsole.vbs" KeyPath="yes" /></Component>
    </ComponentGroup>

    <!-- ═══════ iMobileDevice (Dynamic Full Inclusion) ═══════ -->
    <!-- Uses relative path from .wxs file since <Files> doesn't resolve bindpath like <File Source> -->
    <ComponentGroup Id="IMobileTools" Directory="IMobileDir">
      <Files Include="..\publish\tools\iMobileDevice\**" />
    </ComponentGroup>

    <!-- ═══════ Shortcuts ═══════ -->
    <ComponentGroup Id="Shortcuts" Directory="AppMenuFolder">
      <Component Id="StartMenuShortcut" Guid="22222222-2222-2222-2222-222222222222">
        <Shortcut Id="StartMenuSC" Name="QA QC Device Tool"
                  Target="[#MainExecutable]" WorkingDirectory="INSTALLFOLDER" />
        <RemoveFolder Id="CleanMenu" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\QAQCDeviceTool" Name="installed" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="DesktopSC" Directory="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="33333333-3333-3333-3333-333333333333">
        <Shortcut Id="DesktopSC" Name="QA QC Device Tool"
                  Target="[#MainExecutable]" WorkingDirectory="INSTALLFOLDER" />
        <RegistryValue Root="HKCU" Key="Software\QAQCDeviceTool" Name="desktopsc" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="Assets" Directory="AssetsDir">
      <Component Id="c_adbzip" Guid="*">
        <File Id="f_adbzip" Source="!(bindpath.installer)\assets\platform-tools-latest-windows.zip" KeyPath="yes" />
      </Component>
      <Component Id="c_driverzip" Guid="*">
        <File Id="f_driverzip" Source="!(bindpath.installer)\assets\usb_driver_r13-windows.zip" KeyPath="yes" />
      </Component>
      <Component Id="c_setupandroid" Guid="*">
        <File Id="f_setupandroid" Source="!(bindpath.installer)\assets\SetupAndroid.ps1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="LicensesGroup" Directory="LicensesDir">
      <Component Id="c_license_notices" Guid="*">
        <File Source="!(bindpath.publish)\licenses\THIRD_PARTY_NOTICES.txt" KeyPath="yes" />
      </Component>
      <Component Id="c_license_scrcpy" Guid="*">
        <File Source="!(bindpath.publish)\licenses\LICENSE-scrcpy.txt" KeyPath="yes" />
      </Component>
      <Component Id="c_license_imobile" Guid="*">
        <File Source="!(bindpath.publish)\licenses\LICENSE-libimobiledevice.txt" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- ═══════ Features ═══════ -->
    <Feature Id="ProductFeature" Title="QA/QC Device Tool" Level="1">
      <ComponentGroupRef Id="MainApp" />
      <ComponentGroupRef Id="NativeRuntime" />
      <ComponentGroupRef Id="ScrcpyTools" />
      <ComponentGroupRef Id="IMobileTools" />
      <ComponentGroupRef Id="Shortcuts" />
      <ComponentGroupRef Id="DesktopSC" />
      <ComponentGroupRef Id="Assets" />
      <ComponentGroupRef Id="LicensesGroup" />
    </Feature>

    <!-- ═══════ Custom Actions ═══════ -->
    <CustomAction Id="CA_AndroidSetup" Execute="deferred" Impersonate="no" Return="ignore"
                  Directory="INSTALLFOLDER"
                  ExeCommand="powershell.exe -WindowStyle Hidden -NoProfile -NonInteractive -ExecutionPolicy Bypass -File &quot;[INSTALLFOLDER]assets\SetupAndroid.ps1&quot; &quot;[INSTALLFOLDER]&quot;" />

    <InstallExecuteSequence>
      <Custom Action="CA_AndroidSetup" Before="InstallFinalize" Condition="NOT Installed" />
    </InstallExecuteSequence>

  </Package>
</Wix>
