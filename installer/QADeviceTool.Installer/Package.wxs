<?xml version="1.0" encoding="UTF-8"?>

<!--
    QA Device Tool - WiX Installer Package Definition
    
    This is the main installer definition file. It produces an MSI package
    that installs the QA Device Tool application with proper directory structure,
    shortcuts, and optional dependency handling via custom actions.
-->

<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">

    <Package
        Name="QA Device Tool"
        Manufacturer="QA Device Tool"
        Version="1.0.0.0"
        UpgradeCode="E3B0C442-98FC-1C14-B932-00A0C91E6BF6"
        Scope="perMachine">

        <!-- Upgrade handling -->
        <MajorUpgrade
            DowngradeErrorMessage="A newer version of QA Device Tool is already installed." />

        <!-- Launch conditions — Windows 10+ -->
        <Launch
            Condition="VersionNT &gt;= 603"
            Message="QA Device Tool requires Windows 10 or later." />

        <!-- Media -->
        <MediaTemplate EmbedCab="yes" />

        <!-- ═══════════════════ DIRECTORY STRUCTURE ═══════════════════ -->

        <StandardDirectory Id="ProgramFiles64Folder">
            <Directory Id="INSTALLFOLDER" Name="QA Device Tool">
                <Directory Id="ScriptsFolder" Name="Scripts" />
            </Directory>
        </StandardDirectory>

        <StandardDirectory Id="ProgramMenuFolder">
            <Directory Id="ApplicationProgramsFolder" Name="QA Device Tool" />
        </StandardDirectory>

        <StandardDirectory Id="DesktopFolder" />

        <!-- ═══════════════════ COMPONENTS ═══════════════════ -->

        <!-- Main application files -->
        <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
            
            <!-- Primary executable (placeholder — populated during build) -->
            <Component Id="MainExecutable" Guid="A1B2C3D4-E5F6-7890-ABCD-EF1234567890">
                <File Id="QADeviceToolExe" 
                      Source="!(bindpath.publishDir)\QADeviceTool.exe" 
                      KeyPath="yes" />
            </Component>

            <!-- Runtime config -->
            <Component Id="RuntimeConfig" Guid="B2C3D4E5-F6A7-8901-BCDE-F12345678901">
                <File Id="RuntimeConfigJson"
                      Source="!(bindpath.publishDir)\QADeviceTool.runtimeconfig.json" />
            </Component>

            <!-- DLL files (harvested during build) -->
            <Component Id="MainDll" Guid="C3D4E5F6-A7B8-9012-CDEF-123456789012">
                <File Id="QADeviceToolDll"
                      Source="!(bindpath.publishDir)\QADeviceTool.dll" />
            </Component>

        </ComponentGroup>

        <!-- PowerShell dependency scripts -->
        <ComponentGroup Id="ScriptComponents" Directory="ScriptsFolder">
            <Component Id="DetectScript" Guid="D4E5F6A7-B8C9-0123-DEF0-234567890123">
                <File Id="DetectDependenciesPs1"
                      Source="Scripts\DetectDependencies.ps1"
                      KeyPath="yes" />
            </Component>
            <Component Id="InstallScript" Guid="E5F6A7B8-C9D0-1234-EF01-345678901234">
                <File Id="InstallDependenciesPs1"
                      Source="Scripts\InstallDependencies.ps1" />
            </Component>
            <Component Id="ConfigurePathScript" Guid="F6A7B8C9-D0E1-2345-F012-456789012345">
                <File Id="ConfigurePathPs1"
                      Source="Scripts\ConfigurePath.ps1" />
            </Component>
        </ComponentGroup>

        <!-- Shortcuts -->
        <ComponentGroup Id="ShortcutComponents">
            
            <!-- Desktop shortcut -->
            <Component Id="DesktopShortcut" Directory="DesktopFolder"
                       Guid="A7B8C9D0-E1F2-3456-0123-567890123456">
                <Shortcut Id="DesktopShortcutLink"
                          Name="QA Device Tool"
                          Description="QA utility for device testing"
                          Target="[INSTALLFOLDER]QADeviceTool.exe"
                          WorkingDirectory="INSTALLFOLDER" />
                <RegistryValue Root="HKCU"
                               Key="Software\QADeviceTool"
                               Name="DesktopShortcut"
                               Type="integer"
                               Value="1"
                               KeyPath="yes" />
            </Component>

            <!-- Start Menu shortcut -->
            <Component Id="StartMenuShortcut" Directory="ApplicationProgramsFolder"
                       Guid="B8C9D0E1-F2A3-4567-1234-678901234567">
                <Shortcut Id="StartMenuShortcutLink"
                          Name="QA Device Tool"
                          Description="QA utility for device testing"
                          Target="[INSTALLFOLDER]QADeviceTool.exe"
                          WorkingDirectory="INSTALLFOLDER" />
                <RemoveFolder Id="CleanUpStartMenu"
                              Directory="ApplicationProgramsFolder"
                              On="uninstall" />
                <RegistryValue Root="HKCU"
                               Key="Software\QADeviceTool"
                               Name="StartMenuShortcut"
                               Type="integer"
                               Value="1"
                               KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <!-- Sessions directory creation -->
        <ComponentGroup Id="DirectoryComponents">
            <Component Id="SessionsDirectory" Directory="INSTALLFOLDER"
                       Guid="C9D0E1F2-A3B4-5678-2345-789012345678">
                <CreateFolder />
                <RegistryValue Root="HKCU"
                               Key="Software\QADeviceTool"
                               Name="SessionsDir"
                               Type="string"
                               Value="[PersonalFolder]QA_Device_Tool\Sessions"
                               KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <!-- ═══════════════════ FEATURES ═══════════════════ -->

        <Feature Id="MainApplication" Title="QA Device Tool" Level="1"
                 Description="The main QA Device Tool application."
                 AllowAbsent="no">
            <ComponentGroupRef Id="ProductComponents" />
            <ComponentGroupRef Id="ShortcutComponents" />
            <ComponentGroupRef Id="DirectoryComponents" />
        </Feature>

        <Feature Id="DependencyScripts" Title="Dependency Scripts" Level="1"
                 Description="Scripts for installing and configuring tool dependencies.">
            <ComponentGroupRef Id="ScriptComponents" />
        </Feature>

    </Package>

</Wix>
