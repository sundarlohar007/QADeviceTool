<UserControl x:Class="QADeviceTool.Views.SessionView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:models="clr-namespace:QADeviceTool.Models">

    <Grid Margin="24,16">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="320" />
            <ColumnDefinition Width="*" />
        </Grid.ColumnDefinitions>

        <!-- ═══════ LEFT: Session List ═══════ -->
        <Border Grid.Column="0" Style="{StaticResource GlassCard}" Margin="0,0,8,0">
            <DockPanel>
                <TextBlock DockPanel.Dock="Top" Text="Sessions" Style="{StaticResource TextHeading2}" Margin="0,0,0,12" />

                <!-- New session controls -->
                <Border DockPanel.Dock="Top" Background="{StaticResource BrushBackgroundMedium}"
                        CornerRadius="8" Padding="12" Margin="0,0,0,12">
                    <StackPanel>
                        <!-- Device selector (shows connected devices) -->
                        <TextBlock Text="Select Device" 
                                   Foreground="{StaticResource BrushTextSecondary}"
                                   FontSize="11" Margin="0,0,0,4" />
                        <ComboBox ItemsSource="{Binding AvailableDevices}"
                                  SelectedItem="{Binding SelectedDevice}"
                                  DisplayMemberPath="DisplayName"
                                  Margin="0,0,0,8"
                                  Background="{StaticResource BrushBackgroundDarkest}"
                                  Foreground="{StaticResource BrushTextPrimary}"
                                  BorderBrush="{StaticResource BrushBorder}" />

                        <!-- Optional custom name -->
                        <TextBlock Text="Session name (optional)" 
                                   Foreground="{StaticResource BrushTextSecondary}"
                                   FontSize="11" Margin="0,0,0,4" />
                        <TextBox Style="{StaticResource DarkTextBox}"
                                 Text="{Binding NewSessionName, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,0,0,8" />

                        <Button Style="{StaticResource PrimaryButton}" Content="+ New Session"
                                Command="{Binding CreateSessionCommand}" Margin="0,0,0,8" />

                        <!-- Auto-capture toggle -->
                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                            <CheckBox IsChecked="{Binding AutoCapture}" VerticalAlignment="Center" Margin="0,0,8,0" />
                            <TextBlock Text="Auto-capture on connect" 
                                       Foreground="{StaticResource BrushTextSecondary}" 
                                       FontSize="12" VerticalAlignment="Center" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Session list -->
                <ListBox ItemsSource="{Binding Sessions}"
                         SelectedItem="{Binding SelectedSession}"
                         Style="{StaticResource DarkListBox}"
                         ScrollViewer.VerticalScrollBarVisibility="Auto">
                    <ListBox.ItemContainerStyle>
                        <Style TargetType="ListBoxItem" BasedOn="{StaticResource DarkListBoxItem}">
                            <Setter Property="ContextMenu">
                                <Setter.Value>
                                    <ContextMenu>
                                        <MenuItem Header="Open Directory"  
                                                  Command="{Binding DataContext.OpenSessionFolderCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                                        <Separator Background="{StaticResource BrushBorderMuted}" Margin="0,4" />
                                        <MenuItem Header="Delete Session" 
                                                  Command="{Binding DataContext.DeleteSessionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}" />
                                    </ContextMenu>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.ItemContainerStyle>
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel>
                                <TextBlock Foreground="{StaticResource BrushTextPrimary}"
                                           FontSize="13" FontWeight="SemiBold"
                                           Text="{Binding Name}" />
                                <TextBlock Foreground="{StaticResource BrushTextSecondary}" FontSize="11"
                                           Text="{Binding DurationText}" Margin="0,2,0,0" />
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </DockPanel>
        </Border>

        <!-- ═══════ RIGHT: Log Viewer ═══════ -->
        <Border Grid.Column="1" Style="{StaticResource GlassCard}" Margin="8,0,0,0">
            <DockPanel>
                <!-- Header with actions -->
                <StackPanel DockPanel.Dock="Top" Margin="0,0,0,8">
                    <TextBlock Text="Live Log" Style="{StaticResource TextHeading2}" Margin="0,0,0,12" />
                    
                    <WrapPanel Margin="0,0,0,0">
                        <Button Style="{StaticResource PrimaryButton}" Content="Start"
                                Command="{Binding StartCaptureCommand}"
                                Padding="14,8" FontSize="12" Margin="0,0,8,8" />
                        <Button Style="{StaticResource SecondaryButton}" Content="Stop"
                                Command="{Binding StopCaptureCommand}"
                                Padding="14,8" FontSize="12" Margin="0,0,8,8" />
                        <Button Style="{StaticResource SecondaryButton}" Content="Save"
                                Command="{Binding SaveLogCommand}"
                                Padding="14,8" FontSize="12" Margin="0,0,8,8" />
                        <Button Style="{StaticResource SecondaryButton}" Content="Snap"
                                Command="{Binding TakeSnapshotCommand}"
                                Padding="14,8" FontSize="12" Margin="0,0,8,8" />
                        <Button Style="{StaticResource PrimaryButton}" Content="Bug Report"
                                Command="{Binding GenerateBugReportCommand}"
                                Padding="14,8" FontSize="12" Margin="0,0,8,8" />
                        <Button Style="{StaticResource SecondaryButton}" Content="Open Directory"
                                Command="{Binding OpenSessionFolderCommand}"
                                Padding="12,8" FontSize="12" Margin="0,0,8,8" />
                        <Button Style="{StaticResource SecondaryButton}" Content="Clear"
                                Command="{Binding ClearLogCommand}"
                                Padding="12,8" FontSize="12" Margin="0,0,8,8" />
                        <Button Style="{StaticResource SecondaryButton}" Content="Delete"
                                Command="{Binding DeleteSessionCommand}"
                                Padding="12,8" FontSize="12" Margin="0,0,0,8" />
                    </WrapPanel>
                </StackPanel>

                <!-- Status message -->
                <TextBlock DockPanel.Dock="Top" Text="{Binding StatusMessage}" 
                           Foreground="{StaticResource BrushAccent}"
                           FontSize="12" Margin="0,0,0,6" />

                <!-- Filters -->
                <Grid DockPanel.Dock="Top" Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Orientation="Horizontal">
                        <TextBlock Text="Filter:" VerticalAlignment="Center" Foreground="{StaticResource BrushTextSecondary}" Margin="0,0,8,0" />
                        <ComboBox ItemsSource="{Binding LogLevels}" SelectedItem="{Binding SelectedLogLevel}" Width="100" Margin="0,0,16,0"
                                  Background="{StaticResource BrushBackgroundDarkest}" Foreground="{StaticResource BrushTextPrimary}" />
                    </StackPanel>

                    <TextBox Grid.Column="1" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged, Delay=250}" 
                             Style="{StaticResource DarkTextBox}" />
                </Grid>

                <!-- Log viewer -->
                <ListView x:Name="LogDataGrid"
                          ItemsSource="{Binding LogEntriesView}"
                          VirtualizingStackPanel.IsVirtualizing="True"
                          VirtualizingStackPanel.VirtualizationMode="Recycling"
                          ScrollViewer.HorizontalScrollBarVisibility="Auto"
                          ScrollViewer.VerticalScrollBarVisibility="Auto"
                          Background="{StaticResource BrushBackgroundDarkest}"
                          BorderBrush="{StaticResource BrushBorder}"
                          BorderThickness="1"
                          FontFamily="{StaticResource FontMono}"
                          FontSize="12">
                    
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="Padding" Value="4,2" />
                            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                            <Setter Property="Background" Value="Transparent" />
                            <Setter Property="BorderThickness" Value="0" />
                            <Setter Property="Foreground" Value="{StaticResource BrushTextPrimary}" />
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Error}">
                                    <Setter Property="Foreground" Value="#FFFF6B6B" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Warning}">
                                    <Setter Property="Foreground" Value="#FFFAC041" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Debug}">
                                    <Setter Property="Foreground" Value="#FF6CB9F0" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Info}">
                                    <Setter Property="Foreground" Value="{StaticResource BrushTextPrimary}" />
                                </DataTrigger>
                                <DataTrigger Binding="{Binding Level}" Value="{x:Static models:LogLevel.Verbose}">
                                    <Setter Property="Foreground" Value="{StaticResource BrushTextSecondary}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </ListView.ItemContainerStyle>
                    
                    <ListView.View>
                        <GridView>
                            <GridView.ColumnHeaderContainerStyle>
                                <Style TargetType="GridViewColumnHeader">
                                    <Setter Property="Background" Value="#10FFFFFF" />
                                    <Setter Property="Foreground" Value="{StaticResource BrushTextSecondary}" />
                                    <Setter Property="Padding" Value="8,4" />
                                </Style>
                            </GridView.ColumnHeaderContainerStyle>
                            <GridViewColumn Header="Time" Width="100" DisplayMemberBinding="{Binding Timestamp}" />
                            <GridViewColumn Header="Level" Width="60" DisplayMemberBinding="{Binding Level}" />
                            <GridViewColumn Header="Message" Width="800" DisplayMemberBinding="{Binding Message}" />
                        </GridView>
                    </ListView.View>
                </ListView>
            </DockPanel>
        </Border>
    </Grid>
</UserControl>
